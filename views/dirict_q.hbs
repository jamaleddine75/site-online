<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Direct Question</title>
  <link rel="stylesheet" href="/les_question.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <h1 class="title">Create Direct Question</h1>
      <p class="subtitle">Add a direct answer question</p>

     <form id="directForm" action="/auth/dirict_q" method="POST">
  <div class="form-group">
    <label for="question_text">Question</label>
    <input type="text" id="question_text" name="question_text" 
           placeholder="Enter your question" required class="form-control">
  </div>

  <div class="form-group">
    <label for="correct_answer">Correct Answer</label>
    <input type="text" id="correct_answer" name="correct_answer" 
           placeholder="Enter correct answer" required class="form-control">
  </div>

  <div class="form-group grid">
    <div>
      <label for="time_limit">Time Limit (seconds)</label>
      <input type="number" id="time_limit" name="time_limit" 
             min="5" max="300" class="form-control">
    </div>
    <div>
      <label for="points">Points</label>
      <input type="number" id="points" name="points" 
             min="1" max="100" required class="form-control">
    </div>
  </div>

  <div class="form-actions">
    <button type="submit" class="btn btn-primary">Save Question</button>
    <button type="button" class="btn btn-secondary" 
            onclick="window.location.href='/home'">Return Home</button>
    <button type="button" class="btn btn-success" 
            onclick="saveFinale()">Save as Final</button>

    <!-- Security and reference fields -->
    <input type="hidden" name="_csrf" value="{{csrfToken}}">
    <input type="hidden" name="exam_id" value="{{exam_id}}">
  </div>
</form>
        </div>
      </form>

      <div class="finale-link" id="finaleLink">
        <p id="finaleUrl"></p>
        <button onclick="copyLink()">Copy Link</button>
      </div>

      {{#if message}}
        <h4 class="alert alert-danger mt-4">{{message}}</h4>
      {{/if}}
    </div>
  </div>

  <script>
    async function saveFinale() {
  try {
    // 1. Collect form data
    const formData = {
      question_text: document.getElementById('question_text').value,
      correct_answer: document.getElementById('correct_answer').value,
      time_limit: document.getElementById('time_limit').value || null, // Handle empty
      points: document.getElementById('points').value,
      exam_id: document.querySelector('input[name="exam_id"]').value,
      _csrf: document.querySelector('input[name="_csrf"]').value,
      is_final: true // Flag to indicate this is a final save
    };

    // 2. Validate required fields
    if (!formData.question_text || !formData.correct_answer || !formData.points || !formData.exam_id) {
      throw new Error('Please fill all required fields');
    }

    // 3. Show loading state
    const saveBtn = document.querySelector('button[onclick="saveFinale()"]');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    // 4. Send to server
    const response = await fetch('/auth/save-final-exam', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': formData._csrf
      },
      body: JSON.stringify(formData)
    });

    const result = await response.json();

    if (!response.ok) {
      throw new Error(result.message || 'Failed to save exam');
    }

    // 5. Show success with REAL exam URL (not random)
    const url = `${window.location.origin}/exam/${result.exam_id}`;
    document.getElementById('finaleUrl').href = url;
    document.getElementById('finaleUrl').textContent = url;
    document.getElementById('finaleLink').classList.add('show');

    // 6. Optional: Reset form
    document.getElementById('directForm').reset();

  } catch (error) {
    console.error('Save failed:', error);
    alert(`Error: ${error.message}`);
  } finally {
    // Reset button state
    const saveBtn = document.querySelector('button[onclick="saveFinale()"]');
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save as Final';
    }
  }
}

    function copyLink() {
      const link = document.getElementById('finaleUrl').textContent;
      navigator.clipboard.writeText(link);
      alert("Link copied to clipboard!");
    }
  </script>
</body>
</html>
